<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Analyzer & Position Size</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 min-h-screen font-sans selection:bg-blue-500 selection:text-white">

    <div id="custom-modal"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[9999] hidden transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 rounded-xl p-6 shadow-2xl max-w-sm w-11/12 border border-slate-700 transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-semibold text-red-400 mb-3 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i> Validation Error
            </h3>
            <p id="modal-message" class="text-slate-300 mb-6"></p>
            <button onclick="hideModal()"
                class="w-full bg-red-600 hover:bg-red-500 text-white font-medium py-2 rounded-lg transition-colors">
                Got It
            </button>
        </div>
    </div>

    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 overflow-x-auto">
                <div class="flex items-center flex-shrink-0 gap-2 pr-4">
                    <i data-lucide="candlestick-chart" class="text-blue-500 w-8 h-8"></i>
                    <span class="font-bold text-xl tracking-tight text-white">Trade<span
                            class="text-blue-500">Mate</span></span>
                </div>
                <div class="flex space-x-4 text-sm font-medium flex-shrink-0">
                    <button onclick="showTab('institutional')" id="btn-institutional"
                        class="px-3 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-500 transition-colors whitespace-nowrap">Institutional
                        Mgr</button>
                    <button onclick="showTab('analyzer')" id="btn-analyzer"
                        class="px-3 py-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors whitespace-nowrap">Analyzer</button>
                    <button onclick="showTab('average')" id="btn-average"
                        class="px-3 py-2 rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-colors whitespace-nowrap">Avg.
                        Price</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-6 sm:py-8 sm:px-6 lg:px-8">

        <div id="tab-analyzer" class="space-y-6">
            <div class="bg-slate-800 rounded-xl p-4 sm:p-6 border border-slate-700 shadow-xl">
                <div class="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                    <div class="p-2 bg-blue-500/10 rounded-lg">
                        <i data-lucide="sigma" class="text-blue-500 w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Trade Analyzer</h2>
                        <p class="text-slate-400 text-sm">Input data to instantly view position size and risk metrics.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="space-y-4 lg:col-span-1">
                        <h3 class="text-md font-semibold text-blue-400 border-b border-slate-700 pb-2">Account & Trade
                            Type</h3>

                        <div class="space-y-2">
                            <label class="block text-xs sm:text-sm font-medium text-slate-400">Trade Direction</label>
                            <div class="flex bg-slate-700 rounded-lg p-1" oninput="calcTradeAnalyzer()">
                                <input type="radio" id="trade-buy" name="trade-type" value="buy" class="hidden peer/buy"
                                    checked />
                                <label for="trade-buy"
                                    class="flex-1 text-center py-2 rounded-lg cursor-pointer transition-colors text-white font-medium bg-slate-600 peer-checked/buy:bg-green-600">
                                    Buy (Long)
                                </label>

                                <!-- SELL -->
                                <input type="radio" id="trade-sell" name="trade-type" value="sell"
                                    class="hidden peer/sell" />
                                <label for="trade-sell"
                                    class="flex-1 text-center py-2 rounded-lg cursor-pointer transition-colors text-white font-medium bg-slate-600 peer-checked/sell:bg-red-600">
                                    Sell (Short)
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Total Account
                                    Capital (₹)</label>
                                <input type="number" id="pos-capital" oninput="calcTradeAnalyzer()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                    placeholder="100000">
                            </div>
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Risk per Trade
                                    (%)</label>
                                <input type="number" id="pos-risk-percent" oninput="calcTradeAnalyzer()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                    placeholder="1">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Intraday Leverage
                                (X)</label>
                            <input type="number" id="intraday-leverage" oninput="calcTradeAnalyzer()"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                placeholder="1" value="1">
                        </div>

                        <h3 class="text-md font-semibold text-blue-400 border-b border-slate-700 pb-2 pt-4">Trade Setup
                            Prices</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Entry
                                    Price</label>
                                <input type="number" id="pos-entry" oninput="calcTradeAnalyzer()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                    placeholder="100">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Stop
                                        Loss</label>
                                    <input type="number" id="pos-sl" oninput="calcTradeAnalyzer()"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                        placeholder="95">
                                </div>
                                <div>
                                    <label class="block text-xs sm:text-sm font-medium text-slate-400 mb-1">Target
                                        Price</label>
                                    <input type="number" id="pos-target" oninput="calcTradeAnalyzer()"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 sm:px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                        placeholder="120">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-4">

                        <div class="bg-slate-900/50 rounded-xl p-4 sm:p-6 border border-slate-700 space-y-4">
                            <h3
                                class="text-lg font-semibold text-white flex items-center gap-2 border-b border-slate-700 pb-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-green-400"></i> Target Profit / Loss
                            </h3>

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Target P&L (₹)</p>
                                    <p id="res-target-profit-amt" class="text-xl font-bold text-green-400 mt-1">0</p>
                                </div>
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Return (% on Margin Used)
                                    </p>
                                    <p id="res-target-profit-pct-required"
                                        class="text-xl font-bold text-green-400 mt-1">0.00%</p>
                                </div>
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Return (% on Total
                                        Capital)</p>
                                    <p id="res-target-profit-pct-total" class="text-xl font-bold text-green-400 mt-1">
                                        0.00%</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 rounded-xl p-4 sm:p-6 border border-slate-700 space-y-4">
                            <h3
                                class="text-lg font-semibold text-white flex items-center gap-2 border-b border-slate-700 pb-2">
                                <i data-lucide="credit-card" class="w-5 h-5 text-blue-400"></i>Position Sizing & Margin
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Quantity</p>
                                    <p id="res-qty" class="text-xl font-bold text-white mt-1">0</p>
                                </div>
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Max Risk Amt (₹)</p>
                                    <p id="res-risk-amt" class="text-xl font-bold text-red-400 mt-1">0</p>
                                </div>
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Risk % (Actual)</p>
                                    <p id="res-risk-percent-out" class="text-xl font-bold text-red-400 mt-1">0%</p>
                                </div>
                                <div class="p-2 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Required Margin (₹)</p>
                                    <p id="res-capital-req" class="text-xl font-bold text-blue-400 mt-1">0</p>
                                </div>

                            </div>
                        </div>

                        <div class="bg-slate-900/50 rounded-xl p-4 sm:p-6 border border-slate-700 space-y-4">
                            <h3
                                class="text-lg font-semibold text-white flex items-center gap-2 border-b border-slate-700 pb-2">
                                <i data-lucide="scale" class="w-5 h-5 text-purple-400"></i> Risk:Reward Analysis
                            </h3>

                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Risk/Share</p>
                                    <p id="rr-risk-val" class="text-xl font-bold text-red-400 mt-1">0.00</p>
                                </div>
                                <div class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Reward/Share</p>
                                    <p id="rr-reward-val" class="text-xl font-bold text-green-400 mt-1">0.00</p>
                                </div>
                                <div class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                                    <p class="text-xs text-slate-400 uppercase tracking-wider">Ratio</p>
                                    <p id="rr-ratio-val" class="text-xl font-bold text-white mt-1">1 : 0</p>
                                </div>
                            </div>

                            <div class="relative h-4 bg-slate-700 rounded-full overflow-hidden w-full mt-4">
                                <div id="risk-bar"
                                    class="absolute left-0 top-0 h-full bg-red-500 transition-all duration-500"
                                    style="width: 50%"></div>
                                <div id="reward-bar"
                                    class="absolute right-0 top-0 h-full bg-green-500 transition-all duration-500"
                                    style="width: 50%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500 mt-2 px-1">
                                <span>SL</span>
                                <span>Entry</span>
                                <span>Target</span>
                            </div>

                            <div id="rr-verdict"
                                class="mt-4 text-center py-2 rounded bg-slate-800 text-sm font-medium text-slate-300">
                                Enter all trade values to see analysis
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-average" class="hidden space-y-6">
            <div class="bg-slate-800 rounded-xl p-4 sm:p-6 border border-slate-700 shadow-xl">
                <div class="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                    <div class="p-2 bg-emerald-500/10 rounded-lg">
                        <i data-lucide="layers" class="text-emerald-500 w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Average Price Calculator</h2>
                        <p class="text-slate-400 text-sm">Calculate weighted average price for 2 entries.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700 relative">
                            <span
                                class="absolute -top-2.5 left-3 bg-slate-800 text-xs text-emerald-400 px-2 border border-slate-700 rounded">First
                                Entry (Original)</span>
                            <div class="grid grid-cols-2 gap-4 mt-1">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Price</label>
                                    <input type="number" id="avg-p1"
                                        class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none"
                                        placeholder="100">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Quantity</label>
                                    <input type="number" id="avg-q1"
                                        class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none"
                                        placeholder="100">
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700 relative">
                            <span
                                class="absolute -top-2.5 left-3 bg-slate-800 text-xs text-emerald-400 px-2 border border-slate-700 rounded">Second
                                Entry</span>
                            <div class="grid grid-cols-2 gap-4 mt-1">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Price</label>
                                    <input type="number" id="avg-p2"
                                        class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none"
                                        placeholder="90">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Quantity</label>
                                    <input type="number" id="avg-q2"
                                        class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none"
                                        placeholder="100">
                                </div>
                            </div>
                        </div>

                        <button onclick="calcAverage()"
                            class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-2.5 rounded-lg transition-all shadow-lg shadow-emerald-500/20">
                            Calculate Average
                        </button>
                    </div>

                    <div
                        class="flex flex-col justify-center bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700 p-4 sm:p-6 text-center">
                        <h3 class="text-slate-400 text-sm uppercase tracking-wider mb-2">New Weighted Average Price</h3>
                        <div class="flex items-baseline justify-center gap-1 mb-6">
                            <span class="text-lg text-slate-400">₹</span>
                            <span id="avg-result-price" class="text-4xl font-bold text-white">0.00</span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 border-t border-slate-700 pt-4">
                            <div>
                                <p class="text-xs text-slate-500">Total Quantity</p>
                                <p id="avg-result-qty" class="text-lg font-semibold text-slate-200">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500">Total Invested</p>
                                <p id="avg-result-invested" class="text-lg font-semibold text-slate-200">₹0</p>
                            </div>
                        </div>
                        <div id="avg-breakeven" class="mt-4 text-sm font-medium text-slate-300">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-institutional" class="hidden space-y-6">
            <div class="bg-slate-800 rounded-xl p-4 sm:p-6 border border-slate-700 shadow-xl">
                <div class="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                    <div class="p-2 bg-indigo-500/10 rounded-lg">
                        <i data-lucide="shield-check" class="text-indigo-500 w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Institutional Risk Manager</h2>
                        <p class="text-slate-400 text-sm">3-Entry downside averaging & Monthly performance projection.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Left Column: Inputs -->
                    <div class="lg:col-span-5 space-y-6">
                        <div class="bg-slate-900/40 p-5 rounded-xl border border-slate-700 space-y-4">
                            <h3 class="text-indigo-400 font-semibold flex items-center gap-2">
                                <i data-lucide="wallet" class="w-4 h-4"></i> Capital Settings
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1 caps">Total Capital (₹)</label>
                                    <input type="number" id="inst-capital" oninput="calcInstRisk(); calcMonthlyReturn()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 transition-all font-mono"
                                        placeholder="100000">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Risk per Trade (%)</label>
                                    <input type="number" id="inst-risk-pct" oninput="calcInstRisk()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 transition-all font-mono"
                                        placeholder="1">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">Intraday Leverage (X)</label>
                                <input type="number" id="inst-leverage" oninput="calcInstRisk()"
                                    class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 transition-all font-mono"
                                    placeholder="1" value="1">
                            </div>
                        </div>

                        <div class="bg-slate-900/40 p-5 rounded-xl border border-slate-700 space-y-4">
                            <h3 class="text-indigo-400 font-semibold flex items-center gap-2">
                                <i data-lucide="arrow-down-right" class="w-4 h-4"></i> Downside Entries
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-[55px_1fr_max-content_max-content] items-center gap-1.5">
                                    <span class="text-xs text-slate-500 font-medium whitespace-nowrap">Entry 1</span>
                                    <input type="number" id="inst-e1" oninput="calcInstRisk('e1')"
                                        class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 font-mono text-xs w-full"
                                        placeholder="Price">
                                    <select id="inst-w1" onchange="calcInstRisk('w1')"
                                        class="bg-slate-900 border border-slate-700 rounded-lg px-1.5 py-2 text-[10px] text-slate-300 outline-none w-14">
                                        <option value="0.2">20%</option>
                                        <option value="0.333" selected>Equal</option>
                                        <option value="0.5">50%</option>
                                    </select>
                                    <input type="number" id="inst-q1" oninput="calcInstRisk('q1')"
                                        class="w-12 bg-slate-900/50 border border-slate-700 rounded px-1.5 py-1 text-[10px] text-indigo-400 font-mono text-right outline-none focus:ring-1 focus:ring-indigo-500 hover:bg-slate-900 transition-colors"
                                        placeholder="0">
                                </div>
                                <div class="grid grid-cols-[55px_1fr_max-content_max-content] items-center gap-1.5">
                                    <span class="text-xs text-slate-500 font-medium whitespace-nowrap">Entry 2</span>
                                    <input type="number" id="inst-e2" oninput="calcInstRisk('e2')"
                                        class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 font-mono text-xs w-full"
                                        placeholder="Price">
                                    <select id="inst-w2" onchange="calcInstRisk('w2')"
                                        class="bg-slate-900 border border-slate-700 rounded-lg px-1.5 py-2 text-[10px] text-slate-300 outline-none w-14">
                                        <option value="0.3">30%</option>
                                        <option value="0.333" selected>Equal</option>
                                        <option value="0.2">20%</option>
                                    </select>
                                    <input type="number" id="inst-q2" oninput="calcInstRisk('q2')"
                                        class="w-12 bg-slate-900/50 border border-slate-700 rounded px-1.5 py-1 text-[10px] text-indigo-400 font-mono text-right outline-none focus:ring-1 focus:ring-indigo-500 hover:bg-slate-900 transition-colors"
                                        placeholder="0">
                                </div>
                                <div class="grid grid-cols-[55px_1fr_max-content_max-content] items-center gap-1.5">
                                    <span class="text-xs text-slate-500 font-medium whitespace-nowrap">Entry 3</span>
                                    <input type="number" id="inst-e3" oninput="calcInstRisk('e3')"
                                        class="bg-slate-800/80 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 font-mono text-xs w-full"
                                        placeholder="Price">
                                    <select id="inst-w3" onchange="calcInstRisk('w3')"
                                        class="bg-slate-900 border border-slate-700 rounded-lg px-1.5 py-2 text-[10px] text-slate-300 outline-none w-14">
                                        <option value="0.5">50%</option>
                                        <option value="0.334" selected>Equal</option>
                                        <option value="0.3">30%</option>
                                    </select>
                                    <input type="number" id="inst-q3" oninput="calcInstRisk('q3')"
                                        class="w-12 bg-slate-900/50 border border-slate-700 rounded px-1.5 py-1 text-[10px] text-indigo-400 font-mono text-right outline-none focus:ring-1 focus:ring-indigo-500 hover:bg-slate-900 transition-colors"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-900/40 p-5 rounded-xl border border-slate-700 space-y-4">
                            <h3 class="text-indigo-400 font-semibold flex items-center gap-2">
                                <i data-lucide="crosshair" class="w-4 h-4"></i> Strategy Exit
                            </h3>
                            <div class="grid grid-cols-4 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Stop Loss</label>
                                    <input type="number" id="inst-sl" oninput="calcInstRisk()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-red-500 font-mono text-xs"
                                        placeholder="Price">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">CMP</label>
                                    <input type="number" id="inst-cmp" oninput="calcInstRisk()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-blue-500 font-mono text-xs"
                                        placeholder="Price">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Target</label>
                                    <input type="number" id="inst-target" oninput="calcInstRisk('target')"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-green-500 font-mono text-xs"
                                        placeholder="Price">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Desired RR</label>
                                    <input type="number" id="inst-desired-rr" oninput="calcInstRisk('desired-rr')"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-2 text-white outline-none focus:ring-1 focus:ring-indigo-500 font-mono text-xs"
                                        placeholder="2" value="2">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Results & Pro Stats -->
                    <div class="lg:col-span-7 space-y-6">
                        <!-- Ladder & Averaging Stats -->
                        <div
                            class="bg-indigo-900/10 rounded-xl border border-indigo-500/20 p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="trending-up" class="w-24 h-24 text-indigo-500"></i>
                            </div>

                            <h3 class="text-indigo-300 font-bold text-sm uppercase tracking-widest mb-4">Position
                                Summary</h3>

                            <div class="grid grid-cols-2 gap-8 mb-6">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Weighted Avg. Entry</p>
                                    <p class="text-2xl font-bold text-white flex items-center gap-1">
                                        <span class="text-sm text-indigo-400 italic">₹</span><span
                                            id="inst-res-avg-entry">0.00</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-slate-500 mb-1">Total Quantity</p>
                                    <p id="inst-res-total-qty" class="text-2xl font-bold text-white">0</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-slate-400">Total Capital At Risk</span>
                                        <span id="inst-res-total-risk" class="font-semibold text-red-red-400">₹0</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-slate-400">Margin Required</span>
                                        <span id="inst-res-margin" class="font-semibold text-blue-400">₹0</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-slate-400">Risk-Reward Ratio</span>
                                        <span id="inst-res-rr"
                                            class="px-3 py-1 bg-indigo-500 text-white rounded-full text-xs font-bold transition-all">1
                                            : 0.00</span>
                                    </div>
                                    <div class="relative h-2 bg-slate-700 rounded-full overflow-hidden w-full mt-1">
                                        <div id="inst-risk-bar"
                                            class="absolute left-0 top-0 h-full bg-red-500 transition-all duration-500"
                                            style="width: 50%"></div>
                                        <div id="inst-reward-bar"
                                            class="absolute right-0 top-0 h-full bg-green-500 transition-all duration-500"
                                            style="width: 50%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-slate-400">Actual Risk (%)</span>
                                        <span id="inst-res-risk-pct-out" class="font-semibold text-red-400">0%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <div class="space-y-1">
                                        <p class="text-slate-400">Target Profit (Potential)</p>
                                        <div class="flex gap-4">
                                            <span class="text-[10px] text-slate-500 uppercase">On Margin: <span
                                                    id="inst-res-profit-pct-margin"
                                                    class="text-green-400 font-bold">0%</span></span>
                                            <span class="text-[10px] text-slate-500 uppercase">On Capital: <span
                                                    id="inst-res-profit-pct-capital"
                                                    class="text-green-400 font-bold">0%</span></span>
                                        </div>
                                    </div>
                                    <span id="inst-res-profit" class="font-semibold text-green-400">₹0</span>
                                </div>
                            </div>

                            <!-- Visual Ladder (Interactive) -->
                            <div id="ladder-container"
                                class="mt-12 relative h-16 flex items-center select-none cursor-crosshair">
                                <div class="absolute inset-x-0 h-1 bg-slate-700/50 rounded-full"></div>

                                <!-- Stop Loss Dot -->
                                <div id="ladder-sl" class="absolute h-full flex flex-col items-center group touch-none"
                                    style="left: 0%">
                                    <span
                                        class="text-[9px] text-red-500 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-sl">₹0</span>
                                    <div class="w-4 h-4 bg-red-500 rounded-full border-2 border-slate-900 shadow-lg cursor-ew-resize active:scale-125 transition-transform"
                                        title="Stop Loss (Drag to Adjust)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">SL</span>
                                </div>

                                <!-- Entry Dots -->
                                <div id="ladder-e3" class="absolute h-full flex flex-col items-center group touch-none"
                                    style="left: 30%">
                                    <span
                                        class="text-[9px] text-indigo-400 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-e3">₹0</span>
                                    <div class="w-3.5 h-3.5 bg-indigo-400 rounded-full border-2 border-slate-900 shadow-lg cursor-ew-resize active:scale-125 transition-transform"
                                        title="Entry 3 (Drag to Adjust)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">E3</span>
                                </div>
                                <div id="ladder-e2" class="absolute h-full flex flex-col items-center group touch-none"
                                    style="left: 50%">
                                    <span
                                        class="text-[9px] text-indigo-500 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-e2">₹0</span>
                                    <div class="w-3.5 h-3.5 bg-indigo-500 rounded-full border-2 border-slate-900 shadow-lg cursor-ew-resize active:scale-125 transition-transform"
                                        title="Entry 2 (Drag to Adjust)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">E2</span>
                                </div>
                                <div id="ladder-e1" class="absolute h-full flex flex-col items-center group touch-none"
                                    style="left: 70%">
                                    <span
                                        class="text-[9px] text-indigo-600 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-e1">₹0</span>
                                    <div class="w-4 h-4 bg-indigo-600 rounded-full border-2 border-slate-900 shadow-lg cursor-ew-resize active:scale-125 transition-transform"
                                        title="Entry 1 (Drag to Adjust)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">E1</span>
                                </div>

                                <!-- Target Dot -->
                                <div id="ladder-target"
                                    class="absolute h-full flex flex-col items-center group touch-none"
                                    style="left: 100%">
                                    <span
                                        class="text-[9px] text-green-500 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-target">₹0</span>
                                    <div class="w-4 h-4 bg-green-500 rounded-full border-2 border-slate-900 shadow-lg cursor-ew-resize active:scale-125 transition-transform"
                                        title="Target (Drag to Adjust)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">TARGET</span>
                                </div>

                                <!-- Break-even Marker (BE) -->
                                <div id="ladder-be"
                                    class="absolute h-full flex flex-col items-center group pointer-events-none z-10"
                                    style="left: 50%">
                                    <span
                                        class="text-[9px] text-yellow-400 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-be">₹0</span>
                                    <div class="w-3 h-3 bg-yellow-400 rounded-full border-2 border-slate-900 shadow-lg"
                                        title="Break-even (Avg Entry)"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">BE</span>
                                </div>

                                <!-- Current Price Marker (CMP) -->
                                <div id="ladder-cmp"
                                    class="absolute h-full flex flex-col items-center group pointer-events-none z-20"
                                    style="left: 0%">
                                    <span
                                        class="text-[9px] text-blue-400 font-bold mb-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
                                        id="lbl-cmp">₹0</span>
                                    <div class="w-3.5 h-3.5 bg-blue-500 rounded-full border-2 border-slate-900 shadow-lg animate-pulse"
                                        title="Current Price"></div>
                                    <span class="text-[8px] text-slate-500 mt-1">CMP</span>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Return Section -->
                        <div class="bg-slate-900/60 rounded-xl border border-slate-700/50 p-6">
                            <h3 class="text-indigo-400 font-semibold flex items-center gap-2 mb-4">
                                <i data-lucide="calendar" class="w-5 h-5 text-emerald-400"></i> Monthly Return
                                Calculator (Pro)
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Win Rate %</label>
                                    <input type="number" id="inst-win-rate" value="50" oninput="calcMonthlyReturn()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-white outline-none">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Trades / Mo</label>
                                    <input type="number" id="inst-trade-count" value="20" oninput="calcMonthlyReturn()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-white outline-none">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Avg. RR</label>
                                    <input type="number" id="inst-avg-rr" value="2.5" oninput="calcMonthlyReturn()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-white outline-none">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1 uppercase">Risk % /
                                        Trade</label>
                                    <input type="number" id="inst-risk-per-trade" value="1"
                                        oninput="calcMonthlyReturn()"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-white outline-none">
                                </div>
                            </div>

                            <div
                                class="flex items-center gap-6 p-4 bg-emerald-500/5 border border-emerald-500/20 rounded-xl">
                                <div class="flex-1">
                                    <p class="text-xs text-emerald-500/70 font-medium uppercase">Expected Monthly Return
                                    </p>
                                    <p id="inst-res-mo-ret-pct" class="text-3xl font-black text-emerald-400">0.00%</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-emerald-500/70 font-medium uppercase">Profit Potential</p>
                                    <p id="inst-res-mo-ret-amt" class="text-xl font-bold text-white">₹0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="max-w-4xl mx-auto text-center py-6 text-slate-600 text-sm">
        <p>A specialized toolkit for Indian Share Market Traders</p>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Custom Modal Functions (Replacing alert())
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');

        function showModal(message) {
            modalMessage.innerText = message;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        }

        function hideModal() {
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Tab Switching Logic
        function showTab(tabName) {
            const tabIds = ['tab-analyzer', 'tab-average', 'tab-institutional'];
            const buttonIds = ['btn-analyzer', 'btn-average', 'btn-institutional'];

            tabIds.forEach(id => document.getElementById(id).classList.add('hidden'));

            buttonIds.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.classList.remove('bg-blue-600', 'text-white', 'bg-slate-700');
                btn.classList.add('text-slate-400');
            });

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            const activeBtn = document.getElementById(`btn-${tabName}`);
            activeBtn.classList.remove('text-slate-400');
            if (tabName === 'analyzer') {
                activeBtn.classList.add('bg-blue-600', 'text-white');
            } else if (tabName === 'average') {
                activeBtn.classList.add('bg-slate-700', 'text-white');
            } else {
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }

            // Re-apply correct toggle styles on tab switch
            if (tabName === 'analyzer') {
                updateTradeToggleStyle();
            }
        }

        // Function to update the visual style of the Buy/Sell toggle
        function updateTradeToggleStyle() {
            const buyLabel = document.querySelector('label[for="trade-buy"]');
            const sellLabel = document.querySelector('label[for="trade-sell"]');
            const btnBuy = document.getElementById('trade-buy');

            if (btnBuy && btnBuy.checked) {
                buyLabel.classList.add('bg-green-600', 'text-white');
                buyLabel.classList.remove('bg-slate-600');
                sellLabel.classList.add('bg-slate-600');
                sellLabel.classList.remove('bg-red-600', 'text-white');
            } else if (sellLabel) {
                sellLabel.classList.add('bg-red-600', 'text-white');
                sellLabel.classList.remove('bg-slate-600');
                buyLabel.classList.add('bg-slate-600');
                buyLabel.classList.remove('bg-green-600', 'text-white');
            }
        }


        // Initialize the first tab as active
        window.onload = () => {
            lucide.createIcons();
            showTab('institutional');
            // Initial run of the calculations on load
            calcInstRisk();
            calcMonthlyReturn();
            calcTradeAnalyzer();
        }

        // Helper for formatting currency (Indian Rupees)
        function formatCurrency(amount) {
            if (amount === 0) return '₹0.00';
            const sign = amount < 0 ? '-' : '';
            const absAmount = Math.abs(amount);
            return sign + '₹' + absAmount.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
        }

        // Helper for formatting percentage
        function formatPercent(amount) {
            return amount.toFixed(2) + '%';
        }


        // 1. COMBINED TRADE ANALYZER (Position Size + R:R + P&L + Leverage)
        // This function runs automatically on every input change (oninput)
        function calcTradeAnalyzer() {
            updateTradeToggleStyle();

            const capital = parseFloat(document.getElementById('pos-capital').value) || 0;
            const riskPercent = parseFloat(document.getElementById('pos-risk-percent').value) || 0;
            const entry = parseFloat(document.getElementById('pos-entry').value) || 0;
            const sl = parseFloat(document.getElementById('pos-sl').value) || 0;
            const target = parseFloat(document.getElementById('pos-target').value) || 0;
            const leverage = parseFloat(document.getElementById('intraday-leverage').value) || 1;
            const tradeType = document.querySelector('input[name="trade-type"]:checked').value;


            if (capital <= 0 || riskPercent <= 0 || entry <= 0 || sl <= 0 || target <= 0 || entry === sl || leverage < 1) {
                document.getElementById('res-target-profit-amt').innerText = formatCurrency(0);
                document.getElementById('res-target-profit-pct-required').innerText = formatPercent(0);
                document.getElementById('res-target-profit-pct-total').innerText = formatPercent(0);

                document.getElementById('res-qty').innerText = 0;
                document.getElementById('res-capital-req').innerText = formatCurrency(0);
                document.getElementById('res-risk-percent-out').innerText = `0%`;
                document.getElementById('res-risk-amt').innerText = formatCurrency(0);

                document.getElementById('rr-risk-val').innerText = '0.00';
                document.getElementById('rr-reward-val').innerText = '0.00';
                document.getElementById('rr-ratio-val').innerText = '1 : 0';
                document.getElementById('risk-bar').style.width = '50%';
                document.getElementById('reward-bar').style.width = '50%';

                const verdictEl = document.getElementById('rr-verdict');
                verdictEl.innerText = `Enter all trade values to see analysis`;
                verdictEl.className = "mt-4 text-center py-2 rounded bg-slate-800 text-sm font-medium text-slate-300";

                const PnL_elements = ['res-target-profit-amt', 'res-target-profit-pct-required', 'res-target-profit-pct-total'];
                PnL_elements.forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.remove('text-green-400', 'text-red-400');
                    el.classList.add('text-white');
                });
                return;
            }

            const maxLossAmount = (capital * riskPercent) / 100;
            const riskPerShare = Math.abs(entry - sl);
            let quantity = Math.floor(maxLossAmount / riskPerShare);
            let requiredMargin = (quantity * entry) / leverage;

            if (requiredMargin > capital) {
                quantity = Math.floor((capital * leverage) / entry);
                requiredMargin = (quantity * entry) / leverage;
            }

            const actualMaxLoss = quantity * riskPerShare;
            const riskPctOfCapital = (actualMaxLoss / capital) * 100;

            let profitPerShare = (tradeType === 'buy') ? (target - entry) : (entry - target);
            const targetProfitAmount = quantity * profitPerShare;
            const targetProfitPercentRequired = (requiredMargin > 0) ? (targetProfitAmount / requiredMargin) * 100 : 0;
            const targetProfitPercentTotal = (capital > 0) ? (targetProfitAmount / capital) * 100 : 0;

            document.getElementById('res-qty').innerText = quantity.toLocaleString('en-IN');
            document.getElementById('res-capital-req').innerText = formatCurrency(requiredMargin);
            document.getElementById('res-risk-percent-out').innerText = `${riskPctOfCapital.toFixed(2)}%`;
            document.getElementById('res-risk-amt').innerText = formatCurrency(actualMaxLoss);

            document.getElementById('res-target-profit-amt').innerText = formatCurrency(targetProfitAmount);
            document.getElementById('res-target-profit-pct-required').innerText = formatPercent(targetProfitPercentRequired);
            document.getElementById('res-target-profit-pct-total').innerText = formatPercent(targetProfitPercentTotal);

            const PnL_elements = [document.getElementById('res-target-profit-amt'), document.getElementById('res-target-profit-pct-required'), document.getElementById('res-target-profit-pct-total')];
            PnL_elements.forEach(el => {
                el.classList.remove('text-green-400', 'text-red-400', 'text-white');
                if (targetProfitAmount > 0) el.classList.add('text-green-400');
                else if (targetProfitAmount < 0) el.classList.add('text-red-400');
                else el.classList.add('text-white');
            });

            const reward = Math.abs(profitPerShare);
            const ratio = (reward / riskPerShare);
            document.getElementById('rr-risk-val').innerText = riskPerShare.toFixed(2);
            document.getElementById('rr-reward-val').innerText = reward.toFixed(2);
            document.getElementById('rr-ratio-val').innerText = isFinite(ratio) ? `1 : ${ratio.toFixed(2)}` : "1 : 0";

            const totalRR = riskPerShare + reward;
            document.getElementById('risk-bar').style.width = `${(riskPerShare / totalRR) * 100}%`;
            document.getElementById('reward-bar').style.width = `${(reward / totalRR) * 100}%`;

            const verdictEl = document.getElementById('rr-verdict');
            if (ratio >= 2) {
                verdictEl.innerText = `Excellent Setup (R:R: 1:${ratio.toFixed(2)}). Exceeds 2:1.`;
                verdictEl.className = "mt-4 text-center py-2 rounded bg-green-900/30 text-green-400 border border-green-900 text-sm font-medium";
            } else if (ratio >= 1.5) {
                verdictEl.innerText = `Good Setup (R:R: 1:${ratio.toFixed(2)}). Above 1.5:1.`;
                verdictEl.className = "mt-4 text-center py-2 rounded bg-yellow-900/30 text-yellow-400 border border-yellow-900 text-sm font-medium";
            } else if (ratio >= 1) {
                verdictEl.innerText = `Minimum Acceptable (R:R: 1:${ratio.toFixed(2)}). At least 1:1.`;
                verdictEl.className = "mt-4 text-center py-2 rounded bg-slate-700 text-slate-300 border border-slate-600 text-sm font-medium";
            } else {
                verdictEl.innerText = `Poor Setup (R:R: 1:${ratio.toFixed(2)}). Risk is higher than reward.`;
                verdictEl.className = "mt-4 text-center py-2 rounded bg-red-900/30 text-red-400 border border-red-900 text-sm font-medium";
            }
        }

        // 2. Average Price Calculator
        function calcAverage() {
            const p1 = parseFloat(document.getElementById('avg-p1').value) || 0;
            const q1 = parseFloat(document.getElementById('avg-q1').value) || 0;
            const p2 = parseFloat(document.getElementById('avg-p2').value) || 0;
            const q2 = parseFloat(document.getElementById('avg-q2').value) || 0;

            if (p1 <= 0 || q1 <= 0) return showModal("Please enter valid Price and Quantity for the first entry.");

            const totalQty = q1 + q2;
            const totalInvested = (p1 * q1) + (p2 * q2);
            const avgPrice = totalQty > 0 ? (totalInvested / totalQty) : 0;

            document.getElementById('avg-result-price').innerText = avgPrice.toFixed(2);
            document.getElementById('avg-result-qty').innerText = totalQty.toLocaleString('en-IN');
            document.getElementById('avg-result-invested').innerText = formatCurrency(totalInvested);

            const breakevenEl = document.getElementById('avg-breakeven');
            if (p2 === 0 || q2 === 0) {
                breakevenEl.innerHTML = `<p class="text-slate-500">Add a second entry to calculate the new average.</p>`;
            } else {
                const diff = avgPrice - p1;
                const pct = (diff / p1) * 100;
                if (avgPrice < p1) {
                    breakevenEl.innerHTML = `<p class="text-sm font-semibold mt-4 text-green-400">Averaging Down Success: Break-even now ₹${avgPrice.toFixed(2)}. Needs ${Math.abs(pct).toFixed(2)}% up to reach origin.</p>`;
                } else if (avgPrice > p1) {
                    breakevenEl.innerHTML = `<p class="text-sm font-semibold mt-4 text-red-400">Averaging Up: Break-even now ₹${avgPrice.toFixed(2)}. ${Math.abs(pct).toFixed(2)}% higher than origin.</p>`;
                } else {
                    breakevenEl.innerHTML = `<p class="text-slate-500">Average price remains ₹${avgPrice.toFixed(2)}.</p>`;
                }
            }
        }

        // 3. Institutional Risk Manager Logic (3-Entry Averaging)
        function calcInstRisk(source) {
            const capital = parseFloat(document.getElementById('inst-capital').value) || 0;
            const riskPct = parseFloat(document.getElementById('inst-risk-pct').value) || 0;
            const totalRiskAmt = (capital * riskPct) / 100;
            const leverage = parseFloat(document.getElementById('inst-leverage').value) || 1;

            const e1 = parseFloat(document.getElementById('inst-e1').value) || 0;
            const e2 = parseFloat(document.getElementById('inst-e2').value) || 0;
            const e3 = parseFloat(document.getElementById('inst-e3').value) || 0;
            const sl = parseFloat(document.getElementById('inst-sl').value) || 0;
            let target = parseFloat(document.getElementById('inst-target').value) || 0;
            let desiredRR = parseFloat(document.getElementById('inst-desired-rr').value) || 2;

            const w1Val = parseFloat(document.getElementById('inst-w1').value) || 0.333;
            const w2Val = parseFloat(document.getElementById('inst-w2').value) || 0.333;
            const w3Val = parseFloat(document.getElementById('inst-w3').value) || 0.334;

            if (capital <= 0 || riskPct <= 0 || e1 <= 0 || sl <= 0 || e1 === sl) {
                ["inst-res-avg-entry", "inst-res-total-qty", "inst-res-rr"].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = id === "inst-res-rr" ? "1 : 0.00" : "0";
                });
                document.getElementById('inst-res-total-risk').innerText = "₹0";
                document.getElementById('inst-res-profit').innerText = "₹0";
                document.getElementById('inst-res-margin').innerText = "₹0";
                document.getElementById('inst-res-risk-pct-out').innerText = "0%";
                if (!source || !source.startsWith('q')) {
                    document.getElementById('inst-q1').value = "0";
                    document.getElementById('inst-q2').value = "0";
                    document.getElementById('inst-q3').value = "0";
                }
                return;
            }

            const entries = [e1, e2, e3];
            const weights = [w1Val, w2Val, w3Val];
            let totalQty = 0, totalCost = 0, actualRiskAmt = 0;
            const entryQtys = [0, 0, 0];

            entries.forEach((price, idx) => {
                const qInput = document.getElementById(`inst-q${idx + 1}`);
                if (price > 0 && sl > 0 && price !== sl) {
                    const weight = weights[idx];
                    const riskPerShare = Math.abs(price - sl);

                    let q;
                    if (source && source.startsWith('q')) {
                        // Use manual quantity
                        q = parseFloat(qInput.value) || 0;
                    } else {
                        // Auto-calculate quantity based on weight
                        q = Math.floor((totalRiskAmt * weight) / riskPerShare);
                        qInput.value = q;
                    }

                    entryQtys[idx] = q;
                    totalQty += q; totalCost += (q * price); actualRiskAmt += (q * riskPerShare);
                } else {
                    if (qInput && (!source || !source.startsWith('q'))) qInput.value = 0;
                }
            });

            if (totalQty === 0) return;

            const avgEntry = totalCost / totalQty;
            const cmp = parseFloat(document.getElementById('inst-cmp').value) || 0;
            const riskFromAvg = Math.abs(avgEntry - sl);

            // Target / RR Synchronization
            if (source === 'desired-rr' && desiredRR > 0 && riskFromAvg > 0) {
                const isLong = avgEntry > sl;
                target = isLong ? (avgEntry + (riskFromAvg * desiredRR)) : (avgEntry - (riskFromAvg * desiredRR));
                document.getElementById('inst-target').value = target.toFixed(2);
            } else if (riskFromAvg > 0) {
                const rewardPerShare = Math.abs(target - avgEntry);
                desiredRR = rewardPerShare / riskFromAvg;
                document.getElementById('inst-desired-rr').value = desiredRR.toFixed(2);
            }

            const rewardPerShare = Math.abs(target - avgEntry);
            const rr = riskFromAvg > 0 ? (rewardPerShare / riskFromAvg) : 0;
            const potentialProfit = totalQty * rewardPerShare;
            const marginRequired = totalCost / leverage;
            const actualRiskPct = (actualRiskAmt / capital) * 100;

            const roiMargin = (potentialProfit / marginRequired) * 100 || 0;
            const roiCapital = (potentialProfit / capital) * 100 || 0;

            document.getElementById('inst-res-avg-entry').innerText = avgEntry.toFixed(2);
            document.getElementById('inst-res-total-qty').innerText = totalQty.toLocaleString('en-IN');
            document.getElementById('inst-res-total-risk').innerText = formatCurrency(actualRiskAmt);
            document.getElementById('inst-res-rr').innerText = `1 : ${rr.toFixed(2)}`;
            document.getElementById('inst-res-profit').innerText = formatCurrency(potentialProfit);
            document.getElementById('inst-res-margin').innerText = formatCurrency(marginRequired);
            document.getElementById('inst-res-risk-pct-out').innerText = actualRiskPct.toFixed(2) + "%";

            document.getElementById('inst-res-profit-pct-margin').innerText = roiMargin.toFixed(2) + "%";
            document.getElementById('inst-res-profit-pct-capital').innerText = roiCapital.toFixed(2) + "%";

            // Update RR Bar
            const totalRR = riskFromAvg + rewardPerShare;
            if (totalRR > 0) {
                document.getElementById('inst-risk-bar').style.width = `${(riskFromAvg / totalRR) * 100}%`;
                document.getElementById('inst-reward-bar').style.width = `${(rewardPerShare / totalRR) * 100}%`;
            }

            // RR Verdict Styling
            const rrEl = document.getElementById('inst-res-rr');
            rrEl.classList.remove('bg-indigo-500', 'bg-green-600', 'bg-red-600', 'bg-yellow-600');
            if (rr >= 2) rrEl.classList.add('bg-green-600');
            else if (rr >= 1.5) rrEl.classList.add('bg-yellow-600');
            else if (rr >= 1) rrEl.classList.add('bg-indigo-500');
            else rrEl.classList.add('bg-red-600');

            // Ladder Position Logic with Padding
            const pts = [e1, e2, e3, sl, target, avgEntry];
            if (cmp > 0) pts.push(cmp);
            const filteredPts = pts.filter(p => p > 0);
            const actualMin = Math.min(...filteredPts), actualMax = Math.max(...filteredPts);
            const actualRange = actualMax - actualMin;
            // Add padding to allows dragging beyond extrema
            const padding = actualRange * 0.1 || actualMin * 0.05 || 10;
            const visMin = actualMin - padding, visMax = actualMax + padding, visRange = visMax - visMin;
            const getPos = (p) => (p > 0 && visRange > 0) ? ((p - visMin) / visRange * 100) : 50;

            document.getElementById('lbl-e1').innerText = `₹${e1}`;
            document.getElementById('lbl-e2').innerText = e2 > 0 ? `₹${e2}` : '-';
            document.getElementById('lbl-e3').innerText = e3 > 0 ? `₹${e3}` : '-';
            document.getElementById('lbl-sl').innerText = `₹${sl}`;
            document.getElementById('lbl-target').innerText = `₹${target}`;
            document.getElementById('lbl-be').innerText = `₹${avgEntry.toFixed(2)}`;
            document.getElementById('lbl-cmp').innerText = cmp > 0 ? `₹${cmp}` : '-';

            document.getElementById('ladder-sl').style.left = `${getPos(sl)}%`;
            document.getElementById('ladder-target').style.left = `${getPos(target)}%`;
            document.getElementById('ladder-be').style.left = `${getPos(avgEntry)}%`;
            if (cmp > 0) {
                document.getElementById('ladder-cmp').style.left = `${getPos(cmp)}%`;
                document.getElementById('ladder-cmp').style.opacity = 1;
            } else {
                document.getElementById('ladder-cmp').style.opacity = 0;
            }

            if (e3 > 0) document.getElementById('ladder-e3').style.left = `${getPos(e3)}%`;
            if (e2 > 0) document.getElementById('ladder-e2').style.left = `${getPos(e2)}%`;
            document.getElementById('ladder-e1').style.left = `${getPos(e1)}%`;

            document.getElementById('ladder-e2').style.opacity = e2 > 0 ? 1 : 0;
            document.getElementById('ladder-e3').style.opacity = e3 > 0 ? 1 : 0;
            document.getElementById('ladder-be').style.opacity = 1;
        }

        function initInstitutionalDrag() {
            const container = document.getElementById('ladder-container');
            if (!container) return;
            let isDragging = false, currentDot = null, currentInput = null;
            const dotMap = { 'ladder-e1': 'inst-e1', 'ladder-e2': 'inst-e2', 'ladder-e3': 'inst-e3', 'ladder-sl': 'inst-sl', 'ladder-target': 'inst-target' };

            const onMove = (e) => {
                if (!isDragging) return;
                const rect = container.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                let pct = Math.max(0, Math.min(100, (x / rect.width) * 100));

                const e1 = parseFloat(document.getElementById('inst-e1').value) || 0;
                const e2 = parseFloat(document.getElementById('inst-e2').value) || 0;
                const e3 = parseFloat(document.getElementById('inst-e3').value) || 0;
                const sl = parseFloat(document.getElementById('inst-sl').value) || 0;
                const target = parseFloat(document.getElementById('inst-target').value) || 0;
                const cmp = parseFloat(document.getElementById('inst-cmp').value) || 0;
                const be = parseFloat(document.getElementById('inst-res-avg-entry').innerText) || 0;

                const pts = [e1, e2, e3, sl, target, be];
                if (cmp > 0) pts.push(cmp);
                const filteredPts = pts.filter(p => p > 0);
                const actualMin = Math.min(...filteredPts), actualMax = Math.max(...filteredPts);
                const actualRange = actualMax - actualMin;
                const padding = actualRange * 0.1 || actualMin * 0.05 || 10;
                const visMin = actualMin - padding, visMax = actualMax + padding, visRange = visMax - visMin;

                if (visRange > 0) {
                    currentInput.value = Math.round(visMin + (visRange * (pct / 100)));
                    calcInstRisk();
                }
            };

            container.addEventListener('mousedown', (e) => {
                const dot = e.target.closest('.touch-none');
                if (dot) { isDragging = true; currentDot = dot; currentInput = document.getElementById(dotMap[dot.id]); container.classList.add('cursor-grabbing'); e.preventDefault(); }
            });
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', () => { isDragging = false; container.classList.remove('cursor-grabbing'); });
            container.addEventListener('touchstart', (e) => {
                const dot = e.target.closest('.touch-none');
                if (dot) { isDragging = true; currentDot = dot; currentInput = document.getElementById(dotMap[dot.id]); e.preventDefault(); }
            }, { passive: false });
            window.addEventListener('touchmove', onMove, { passive: false });
            window.addEventListener('touchend', () => { isDragging = false; });
        }

        function calcMonthlyReturn() {
            const winRate = parseFloat(document.getElementById('inst-win-rate').value) || 0;
            const trades = parseFloat(document.getElementById('inst-trade-count').value) || 0;
            const rr = parseFloat(document.getElementById('inst-avg-rr').value) || 0;
            const riskPerTrade = parseFloat(document.getElementById('inst-risk-per-trade').value) || 0;
            const capital = parseFloat(document.getElementById('inst-capital').value) || 0;

            const expectedReturnPerTrade = ((winRate / 100) * rr * riskPerTrade) - ((1 - winRate / 100) * riskPerTrade);
            const monthlyReturnPct = trades * expectedReturnPerTrade;
            const monthlyProfitAmt = (capital * monthlyReturnPct) / 100;

            document.getElementById('inst-res-mo-ret-pct').innerText = monthlyReturnPct.toFixed(2) + "%";
            document.getElementById('inst-res-mo-ret-amt').innerText = formatCurrency(monthlyProfitAmt);

            const pctEl = document.getElementById('inst-res-mo-ret-pct');
            pctEl.classList.remove('text-emerald-400', 'text-red-400', 'text-slate-400');
            if (monthlyReturnPct > 0) pctEl.classList.add('text-emerald-400');
            else if (monthlyReturnPct < 0) pctEl.classList.add('text-red-400');
            else pctEl.classList.add('text-slate-400');
        }

        window.addEventListener('load', () => {
            calcMonthlyReturn();
            calcInstRisk();
            initInstitutionalDrag();
        });
    </script>
</body>

</html>
